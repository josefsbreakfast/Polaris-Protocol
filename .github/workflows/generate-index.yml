name: Generate Markdown Index

on:
  workflow_dispatch:              # Manual run
  push:                           # Auto-run when Markdown or this workflow changes
    branches: [ main ]
    paths:
      - '**/*.md'
      - '.github/workflows/generate-index.yml'
  schedule:
    - cron: '0 0 * * *'           # Daily at midnight UTC

permissions:
  contents: write                 # Needed to push INDEX.md

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate INDEX.md with Python
        run: |
          python3 - <<'PY'
          import os

          EXCLUDES = (
              '.git' + os.sep,
              'Quarantine' + os.sep,
              os.path.join('scripts','maintenance') + os.sep,
              'Casefiles' + os.sep,
          )

          def excluded(path):
              p = path.replace('./','')
              for x in EXCLUDES:
                  if p.startswith(x):
                      return True
              return False

          files = []
          for root, _, names in os.walk('.', topdown=True):
              root = root.replace('\\','/')
              if excluded(root.strip('./') + ('/' if not root.endswith('/') else '')):
                  continue
              for n in names:
                  if n.endswith('.md'):
                      rel = os.path.join(root, n).replace('\\','/').lstrip('./')
                      if not excluded(rel):
                          files.append(rel)

          files.sort()
          with open('INDEX.md', 'w', encoding='utf-8') as f:
              f.write('# Polaris Protocol - File Index\n\n')
              for p in files:
                  f.write(f'- [{p}](./{p})\n')
          PY

      - name: Commit & push if changed
        run: |
          if git diff --quiet -- INDEX.md; then
            echo "No changes to INDEX.md"
            exit 0
          fi
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add INDEX.md
          git commit -m "ci: update INDEX.md [skip ci]"
          git push
          
